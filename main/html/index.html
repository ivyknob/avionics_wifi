<!DOCTYPE html>
<html>
<head>
  <title>Avionics js</title>
  <script type="text/javascript" defer src="avionics.js.gz"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
      window.avionics = new Avionics(document.body);

      var div = document.createElement('div');
      div.innerHTML = modalTemplate;
      document.body.appendChild(div)
      var modalElement = document.getElementById('modal');
      window.modal = new RModal(
        modalElement
        // options // See "Options" below details
      );

      avionics.elem.querySelector('#barometric_setting').addEventListener('click', function(){
        modal.open();
      })

      modal.dialog.querySelector('form').addEventListener('submit', () => {
        event.preventDefault();
        var settings = {};
        [...event.currentTarget.elements].forEach(({name, value}) => {
          if (name) {
            settings[name] = value;
          }
        });
        fetch("/settings", {
          method: 'POST',
          body: JSON.stringify({settings}),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          }
        })
        .then(res => {
          if (!res.ok) {
            Toastify({
              text: res.statusText,
              duration: 10000,
              backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
              close: true
            }).showToast();
          }
          console.log(res);
        });
      });

      var websocket = new WebSocket('ws://'+location.hostname+'/');

      websocket.onopen = function(evt) {
        Toastify({
          text: 'WebSocket connection opened',
          duration: 10000,
          backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
          close: true
        }).showToast();
      }

      websocket.onmessage = function(evt) {
        var data = JSON.parse(evt.data);
        avionics.roll = data.r;
        avionics.pitch = data.p;
        avionics.heading = data.h;
        avionics.altitude = data.a;
        avionics.airspeed = data.as;
        avionics.selectedAltitude = data.da;
        avionics.groundSpeed = data.gs;
        avionics.qnh = data.qnh;
        avionics.verticalSpeed = data.vsi;
      }

      websocket.onclose = function(evt) {
        Toastify({
          text: 'Websocket connection closed',
          duration: 1e6,
          backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
          close: true
        }).showToast();
      }

      websocket.onerror = function(evt) {
        Toastify({
          text: 'Websocket error: ' + evt,
          duration: 1e6,
          backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
          close: true
        }).showToast();
      }
    });
  </script>
</head>
<body></body>
</html>
