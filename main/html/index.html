<!DOCTYPE html>
<html>
<head>
  <title>Avionics js</title>
  <script type="text/javascript" defer src="avionics.js.gz"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
      window.avionics = new Avionics(document.body);

      var div = document.createElement('div');
      div.innerHTML = modalTemplate;
      document.body.appendChild(div)
      var modalElement = document.getElementById('modal');
      window.modal = new RModal(
        modalElement
        // options // See "Options" below details
      );

      avionics.elem.querySelector('#barometric_setting').addEventListener('click', function(){
        modal.open();
      })

      modal.dialog.querySelector('form').addEventListener('submit', () => {
        event.preventDefault();
        var settings = {};
        [...event.currentTarget.elements].forEach(({name, value}) => {
          if (name) {
            settings[name] = value;
          }
        });
        fetch("/settings", {
          method: 'POST',
          body: JSON.stringify({settings}),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          }
        })
        .then(response => {
          console.log(response)
        });
      });

      var websocket = new WebSocket('ws://'+location.hostname+'/');

      websocket.onopen = function(evt) {
        toastr.success('WebSocket connection opened');
      }

      websocket.onmessage = function(evt) {
        var data = JSON.parse(evt.data);
        avionics.roll = data.r;
        avionics.pitch = data.p;
        avionics.heading = data.h;
        avionics.altitude = data.a;
        avionics.airspeed = data.as;
        avionics.selectedAltitude = data.da;
        avionics.groundSpeed = data.gs;
        avionics.qnh = data.qnh;
        avionics.verticalSpeed = data.vsi;
      }

      websocket.onclose = function(evt) {
        toastr.warning('Websocket connection closed', null, {timeOut: 84600, closeButton: true});
      }

      websocket.onerror = function(evt) {
        toastr.error('Websocket error: ' + evt, null, {timeOut: 84600, closeButton: true});
      }
    });
  </script>
</head>
<body></body>
</html>
